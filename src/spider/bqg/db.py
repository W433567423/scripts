from global_config import conn, console, chunk_size, FrameProgress
from rich.progress import MofNCompleteColumn, BarColumn, TimeRemainingColumn


# ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÂ∞èËØ¥ÂàóË°®
def get_books_list_from_db() -> list:
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    novel_list = []
    novel = {
        "book_name": "",
        "book_link": "",
        "book_author": "",
        "book_publish_time": "",
        "write_status": "",
        "popularity": "",
        "intro": "",
        "abnormal": False,
        "is_extra": False,
    }
    cursor.execute(
        "SELECT book_id,book_name,book_link,book_author,write_status,popularity,intro,file_path,abnormal,is_extra FROM books"
    )
    db_list = cursor.fetchall()
    for item in db_list:
        novel["book_id"] = item[0]
        novel["book_name"] = item[1]
        novel["book_link"] = item[2]
        novel["book_author"] = item[3]
        novel["write_status"] = item[4]
        novel["popularity"] = item[5]
        novel["intro"] = item[6]
        novel["file_path"] = item[7]
        novel["abnormal"] = True if item[8] == 1 else False
        novel["is_extra"] = True if item[9] == 1 else False
        novel_list.append(novel)
    cursor.close()
    return novel_list


# ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊ≤°ÊúâintroÁ≠â‰ø°ÊÅØÁöÑÂ∞èËØ¥ÂàóË°®
def get_no_extra_books_list_from_db() -> list:
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    novel_list = []

    cursor.execute("SELECT book_id FROM books WHERE is_extra=0")
    db_list = cursor.fetchall()
    for item in db_list:
        novel = {
            "book_id": "",
            "abnormal": False,
        }
        novel["book_id"] = item[0]
        novel_list.append(novel)
    cursor.close()
    return novel_list


# ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊ≤°ÊúâÁ´†ËäÇ‰ø°ÊÅØÁöÑÂ∞èËØ¥ÂàóË°®
def get_no_chapter_books_list_from_db() -> list:
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    novel_list = []

    cursor.execute(
        "SELECT book_id,book_name FROM books WHERE is_chapter=0 And abnormal=0 ORDER BY book_id ASC"
    )
    db_list = cursor.fetchall()
    for item in db_list:
        novel = {
            "book_id": "",
            "book_name": "",
            "abnormal": False,
        }
        novel["book_id"] = item[0]
        novel["book_name"] = item[1]
        novel_list.append(novel)
    cursor.close()
    return novel_list


# ÈáçÁΩÆÊï∞ÊçÆÂ∫ìË°®books
def reset_books_to_db() -> None:
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    # Âà†Èô§Ë°®books
    cursor.execute("DROP TABLE IF EXISTS chapters")
    cursor.execute("DROP TABLE IF EXISTS books")
    # ÂàõÂª∫Ë°®booksÔºåbooks_id:‰∏ªÈîÆ
    cursor.execute(
        """
        CREATE TABLE IF NOT EXISTS books(
            book_id INT PRIMARY KEY COMMENT 'Á¨îË∂£ÈòÅÂ∞èËØ¥id',
            book_name VARCHAR(255) COMMENT 'Â∞èËØ¥Âêç' not null,
            book_author VARCHAR(255) COMMENT 'Â∞èËØ¥‰ΩúËÄÖ',
            book_publish_time VARCHAR(255) COMMENT 'Â∞èËØ¥ÂèëÂ∏ÉÊó∂Èó¥',
            write_status VARCHAR(255) COMMENT 'Â∞èËØ¥ËøûËΩΩÁä∂ÊÄÅ',
            file_path VARCHAR(255) COMMENT 'Â∞èËØ¥Êñá‰ª∂Ë∑ØÂæÑ',
            popularity VARCHAR(255) COMMENT 'Â∞èËØ¥‰∫∫Ê∞î',
            intro TEXT COMMENT 'Â∞èËØ¥ÁÆÄ‰ªã',
            abnormal BOOLEAN DEFAULT FALSE COMMENT 'ÊòØÂê¶ÂºÇÂ∏∏',
            is_extra BOOLEAN DEFAULT FALSE COMMENT 'ÊòØÂê¶Â∑≤Ê∑ªÂä†È¢ùÂ§ñ‰ø°ÊÅØ(ËøûËΩΩÊÉÖÂÜµ„ÄÅ‰∫∫Ê∞î„ÄÅËØÑÂàÜÁ≠â)',
            is_chapter BOOLEAN DEFAULT FALSE COMMENT 'ÊòØÂê¶Â∑≤Ê∑ªÂä†Á´†ËäÇ‰ø°ÊÅØ'
        )
    """
    )
    cursor.execute(
        """
        CREATE TABLE IF NOT EXISTS chapters(
            chapter_id INT PRIMARY KEY COMMENT 'Á´†ËäÇid',
            chapter_name VARCHAR(255) COMMENT 'Á´†ËäÇÂêç' not null,
            chapter_order INT COMMENT 'Á´†ËäÇÈ°∫Â∫è',
            book_id INT COMMENT 'Â∞èËØ¥id',
            FOREIGN KEY (book_id) REFERENCES books(book_id)
        )
    """
    )
    conn.commit()
    console.log("Êï∞ÊçÆÂ∫ìË°®booksÈáçÁΩÆÊàêÂäü")
    cursor.close()


# ÈáçÁΩÆÊï∞ÊçÆÂ∫ìË°®chapters
def reset_chapters_to_db() -> None:
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    # Âà†Èô§Ë°®chapters
    cursor.execute("DROP TABLE IF EXISTS chapters")
    # ÂàõÂª∫Ë°®chaptersÔºåchapter_id:‰∏ªÈîÆ,book_id:Â§ñÈîÆ
    cursor.execute(
        """
        CREATE TABLE IF NOT EXISTS chapters(
            chapter_id INT PRIMARY KEY COMMENT 'Á´†ËäÇid',
            chapter_name VARCHAR(255) COMMENT 'Á´†ËäÇÂêç' not null,
            chapter_order INT COMMENT 'Á´†ËäÇÈ°∫Â∫è',
            book_id INT COMMENT 'Â∞èËØ¥id',
            FOREIGN KEY (book_id) REFERENCES books(book_id)
        )
    """
    )
    # Êõ¥Êñ∞booksË°®is_chapterÂ≠óÊÆµ
    cursor.execute("UPDATE books SET is_chapter=False")
    conn.commit()
    console.log("Êï∞ÊçÆÂ∫ìË°®chaptersÈáçÁΩÆÊàêÂäü")
    cursor.close()


# ---------------------Â∞èËØ¥---------------------
# Â≠òÂÇ®Â∞èËØ¥ÂàóË°®Ëá≥Êï∞ÊçÆÂ∫ì
def save_books_list_to_db(novel_list: list) -> None:
    console.log("üöÄ ~ Ê≠£Âú®Â≠òÂÇ®ËøõÊï∞ÊçÆÂ∫ì")
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    # Ëé∑ÂèñÊï∞ÊçÆÂ∫ì‰∏≠Â∑≤ÊúâÁöÑÂ∞èËØ¥ÂàóË°®(‰ªÖËé∑ÂèñÂ∞èËØ¥Âêç)
    cursor.execute("SELECT book_id FROM books")
    overed_novel_list = cursor.fetchall()
    # ‰ªéÂÖÉÁªÑÂàóË°®‰∏≠ÊèêÂèñÂ∞èËØ¥id‰∏∫ÂÖÉÁªÑ
    overed_novel_list_id = []
    for novel in overed_novel_list:
        overed_novel_list_id.append(novel[0])
    with FrameProgress(
        "[progress.description]{task.description}",
        BarColumn(),
        "[progress.percentage]{task.percentage:>3.1f}%",
        MofNCompleteColumn(),
        "[cyan]‚è≥",
        TimeRemainingColumn(),
    ) as progress:
        task = progress.add_task("Â≠òÂÇ®Â∞èËØ¥ÂàóË°®", total=len(novel_list))
        # Â∞ÜlistÂàÜÊØèchunk_sizeÊù°ÊâßË°å‰∏ÄÊ¨°executemany()ÊñπÊ≥ïÊâπÈáèÊõ¥Êñ∞Êï∞ÊçÆ
        cursor.executemany(
            """
                INSERT INTO books(
                    book_id,
                    book_name,
                    book_author,
                    book_publish_time
                )
                VALUES(
                    %s,
                    %s,
                    %s,
                    %s
                )
            """,
            [
                (
                    novel["book_id"],
                    novel["book_name"],
                    novel["book_author"],
                    novel["book_publish_time"],
                )
                for novel in novel_list
                if novel["book_id"] not in overed_novel_list_id
            ],
        )
        progress.update(task, advance=chunk_size)
    conn.commit()
    cursor.close()
    console.log("Â∞èËØ¥ÂàóË°®Â≠òÂÇ®ÊàêÂäü")


# Êõ¥Êñ∞Â∞èËØ¥ÂàóË°®Âà∞Êï∞ÊçÆÂ∫ì
def update_books_list(list: list) -> None:
    console.log("üöÄ ~ Ê≠£Âú®Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì")
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    # ÂàÜÁ±ª(Ê≠£Â∏∏/ÂºÇÂ∏∏)
    right_list = []
    wrong_list = []
    for novel in list:
        if not novel["abnormal"]:
            right_list.append(novel)
        else:
            wrong_list.append(novel)

    with FrameProgress(
        "[progress.description]{task.description}",
        BarColumn(),
        "[progress.percentage]{task.percentage:>3.1f}%",
        MofNCompleteColumn(),
        "[cyan]‚è≥",
        TimeRemainingColumn(),
    ) as progress:
        task1 = progress.add_task("Êõ¥Êñ∞Â∞èËØ¥‰ø°ÊÅØ", total=len(right_list))
        # for novel in right_list:
        #     try:
        #         cursor.execute(
        #             """
        #                 UPDATE books
        #                 SET
        #                     write_status=%s,
        #                     popularity=%s,
        #                     intro=%s,
        #                     is_extra=%s
        #                 WHERE book_id=%s
        #             """,
        #             (
        #                 novel["write_status"],
        #                 novel["popularity"],
        #                 novel["intro"],
        #                 novel["is_extra"],
        #                 novel["book_id"],
        #             ),
        #         )
        #     except Exception as e:
        #         print(f"[red]ÂºÇÂ∏∏:{novel}")
        #     progress.update(task1, advance=1)
        for i in range(0, len(right_list), chunk_size):
            cursor.executemany(
                """
                    UPDATE books
                    SET
                        write_status=%s,
                        popularity=%s,
                        intro=%s,
                        is_extra=%s
                    WHERE book_id=%s
                """,
                [
                    (
                        novel["write_status"],
                        novel["popularity"],
                        novel["intro"],
                        novel["is_extra"],
                        novel["book_id"],
                    )
                    for novel in right_list[i : i + chunk_size]
                ],
            )
            progress.update(task1, advance=chunk_size)
        progress.update(task1, completed=len(right_list))
        console.log(f"[red]‰∏äÊä•ÂºÇÂ∏∏,Êï∞Èáè:{len(wrong_list)}")
        if len(wrong_list) != 0:
            console.log("üöÄ ~ wrong_list:", wrong_list)
            task2 = progress.add_task("Êõ¥Êñ∞ÂºÇÂ∏∏Â∞èËØ¥", total=len(wrong_list))
            for i in range(0, len(wrong_list), chunk_size):
                cursor.executemany(
                    """
                        UPDATE books
                        SET
                            abnormal=True
                        WHERE book_id=%s
                    """,
                    [(novel["book_id"],) for novel in wrong_list[i : i + chunk_size]],
                )
                progress.update(task2, advance=chunk_size)
            progress.update(task2, completed=len(wrong_list))
    conn.commit()
    cursor.close()
    console.log("Â∞èËØ¥ÂàóË°®Êõ¥Êñ∞ÊàêÂäü")


# ---------------------Á´†ËäÇ---------------------
# Â≠òÂÇ®Á´†ËäÇÂàóË°®Ëá≥Êï∞ÊçÆÂ∫ì
def save_chapters_list_to_db(novel_list: list) -> None:
    console.log("üöÄ ~ Ê≠£Âú®Â≠òÂÇ®ËøõÊï∞ÊçÆÂ∫ì")
    global conn
    conn.ping(reconnect=True)
    cursor = conn.cursor()  # ÂàõÂª∫Ê∏∏Ê†á
    with FrameProgress(
        "[progress.description]{task.description}",
        BarColumn(),
        "[progress.percentage]{task.percentage:>3.1f}%",
        MofNCompleteColumn(),
        "[cyan]‚è≥",
        TimeRemainingColumn(),
    ) as progress:
        task = progress.add_task("Â≠òÂÇ®Á´†ËäÇÂàóË°®", total=len(novel_list))
        for novel in novel_list:
            cursor.executemany(
                """
                    INSERT INTO chapters(
                        chapter_id,
                        chapter_name,
                        chapter_order,
                        book_id
                    )
                    VALUES(
                        %s,
                        %s,
                        %s,
                        %s
                    )
                """,
                [
                    (
                        chapter["chapter_id"],
                        chapter["chapter_name"],
                        chapter["chapter_order"],
                        novel["book_id"],
                    )
                    for chapter in novel["chapters_list"]
                ],
            )
            # Êõ¥Êñ∞booksË°®is_chapterÂ≠óÊÆµ
            cursor.execute(
                """
                    UPDATE books
                    SET
                        is_chapter=True
                    WHERE book_id=%s
                """,
                (novel["book_id"],),
            )
            progress.update(task, advance=1)
        conn.commit()
        cursor.close()
        console.log("Á´†ËäÇÂàóË°®Â≠òÂÇ®ÊàêÂäü")
